---
# Please do not edit this file directly; it is auto generated.
# Instead, please edit 07-model-competitation.md in _episodes_rmd/
source: Rmd
title: "Maxent model - model competitation"
teaching: 10
exercises: 5
questions:
- "How to run a lot of model simulations?"
objectives:
- "addddddddddd"
- "addddddddddd"
keypoints:
- "111111"
- "22222"
---



#### prepare data

~~~
###############################################################
library("raster")
library("dismo")
library("ENMeval")

# prepare spatial occ data
if(!file.exists("data/occ_raw.rdata")){
  occ_raw <- gbif(genus="Dasypus",species="novemcinctus",download=TRUE) 
  save(occ_raw,file = "data/occ_raw.rdata")
}else{
  load("data/occ_raw.rdata")
}
occ_clean <- subset(occ_raw,(!is.na(lat))&(!is.na(lon))) 
occ_unique <- occ_clean[!duplicated( occ_clean[c("lat","lon")]  ),]
occ_unique_specimen <- subset(occ_unique, basisOfRecord=="PRESERVED_SPECIMEN")
occ_final <- subset(occ_unique_specimen, year>=1950 & year <=2000)
coordinates(occ_final) <- ~ lon + lat
myCRS1 <- CRS("+init=epsg:4326") # WGS 84
crs(occ_final) <- myCRS1

# prepare raster data
if( !file.exists( paste0("data/bioclim/bio_10m_bil.zip")   )){
  utils::download.file(url="http://biogeo.ucdavis.edu/data/climate/worldclim/1_4/grid/cur/bio_10m_bil.zip",
                       destfile="data/bioclim/bio_10m_bil.zip"   ) 
  utils::unzip("data/bioclim/bio_10m_bil.zip",exdir="data/bioclim") 
}

# load rasters
clim_list <- list.files("data/bioclim/",pattern=".bil$",full.names = T)
clim <- raster::stack(clim_list) 

occ_buffer <- buffer(occ_final,width=4*10^5) #unit is meter
clim_mask <- mask(clim, occ_buffer)

set.seed(1) 
bg <- sampleRandom(x=clim_mask,
                   size=10000,
                   na.rm=T, #removes the 'Not Applicable' points  
                   sp=T) # return spatial points 

temp1 <- extract(clim_mask[[1]],occ_final)
occ_final <- occ_final[!is.na(temp1),]
~~~
{: .language-r}

#### prepare data input for ENMeval  
Before we start, we could increase the RAM allocated to the Java virtual machine.  
`options(java.parameters = "-Xmx1g" )`  

There are several approaches available for fine-turning Maxent model, ENMeval is just one of them. 

We will feed three datasets to ENMeval: coordinates of occurrences, coordinates of background points, raster layers.  

~~~
library(ENMeval)
env <- clim_mask[[c("bio1","bio5","bio6","bio12")]]

occ_coord <- occ_final@coords

bg_coord <- bg@coords
~~~
{: .language-r}

#### parameter manipulations in ENMeval  
We use `RMvalues()` to set a range of *RM values* (beta-multiplier). Here we set RM ranged from *0.5* to *4* at at the interval of *0.5*.  
We can set feature using *fc* (for example, fc = c('L', 'LQ', 'H')).    


"method" is used to spatial parting occurrence data, there are mainly two approaches available in ENM eval, i.e. block and checkerboard methods, the former method is used when your model in a transferred manner/need to be transferred (i.e. in the application of biological invasions, climate change), the latter is used in a none transfer manner (i.e. setting priority area for conservation);  "overlap" is asking whether you are going to perform overlap measurements of Maxent prediction during the iterative running; "bin.output" is asking whether you are going to reserved the iterative prediction##### 



~~~
competition <- ENMevaluate(occ = occ_coord,          # set the occurrence data for ENMeval
                           env = env,          # set the environmental data
                           bg.coords = bg_coord,     # set the background data
                           method = "randomkfold", kfolds=4,
                           RMvalues=seq(0.5,4,0.5),   # set the RM values, here set RM valuse from 0.5 to 5, at an interval of 0.5
                           fc = c("L", "LQ", "H", "LQH") # the feature combinations that will be used for iterative running
                           )
~~~
{: .language-r}



~~~

  |                                                                       
  |                                                                 |   0%
  |                                                                       
  |==                                                               |   3%
  |                                                                       
  |====                                                             |   6%
  |                                                                       
  |======                                                           |   9%
  |                                                                       
  |========                                                         |  12%
  |                                                                       
  |==========                                                       |  16%
  |                                                                       
  |============                                                     |  19%
  |                                                                       
  |==============                                                   |  22%
  |                                                                       
  |================                                                 |  25%
  |                                                                       
  |==================                                               |  28%
  |                                                                       
  |====================                                             |  31%
  |                                                                       
  |======================                                           |  34%
  |                                                                       
  |========================                                         |  38%
  |                                                                       
  |==========================                                       |  41%
  |                                                                       
  |============================                                     |  44%
  |                                                                       
  |==============================                                   |  47%
  |                                                                       
  |================================                                 |  50%
  |                                                                       
  |===================================                              |  53%
  |                                                                       
  |=====================================                            |  56%
  |                                                                       
  |=======================================                          |  59%
  |                                                                       
  |=========================================                        |  62%
  |                                                                       
  |===========================================                      |  66%
  |                                                                       
  |=============================================                    |  69%
  |                                                                       
  |===============================================                  |  72%
  |                                                                       
  |=================================================                |  75%
  |                                                                       
  |===================================================              |  78%
  |                                                                       
  |=====================================================            |  81%
  |                                                                       
  |=======================================================          |  84%
  |                                                                       
  |=========================================================        |  88%
  |                                                                       
  |===========================================================      |  91%
  |                                                                       
  |=============================================================    |  94%
  |                                                                       
  |===============================================================  |  97%
  |                                                                       
  |=================================================================| 100%
~~~
{: .output}



#### Exploration the results.  

~~~
dir.create("temp")
# Look at results table AND save it in working directory for later checking.
head(competition@results)
~~~
{: .language-r}



~~~
  settings features  rm train.AUC avg.test.AUC var.test.AUC avg.diff.AUC
1    L_0.5        L 0.5 0.7179545    0.7169887 1.473511e-03   0.01223741
2   LQ_0.5       LQ 0.5 0.7223189    0.7187274 1.506190e-03   0.01584644
3    H_0.5        H 0.5 0.8045481    0.7917131 3.661897e-05   0.01479021
4  LQH_0.5      LQH 0.5 0.8041092    0.7908580 3.561334e-05   0.01539121
5      L_1        L 1.0 0.7175704    0.7164057 1.377721e-03   0.01174392
6     LQ_1       LQ 1.0 0.7208700    0.7186557 1.550525e-03   0.01510823
  var.diff.AUC avg.test.orMTP var.test.orMTP avg.test.or10pct
1 1.097074e-03    0.001666667   1.111111e-05       0.09980132
2 5.209722e-04    0.001655629   1.096443e-05       0.10649007
3 1.030006e-04    0.003322296   1.471719e-05       0.12481236
4 9.280809e-05    0.003322296   1.471719e-05       0.11482340
5 1.117163e-03    0.001666667   1.111111e-05       0.10146799
6 4.699118e-04    0.001666667   1.111111e-05       0.10982340
  var.test.or10pct     AICc delta.AICc        w.AIC parameters
1     0.0014414137 12777.52   311.4209 1.319342e-68          4
2     0.0014519766 12688.91   222.8103 2.300954e-49          8
3     0.0003133859 12626.57   160.4702 7.923048e-36         38
4     0.0001633085 12641.46   175.3574 4.636298e-39         40
5     0.0016015560 12786.15   320.0450 1.768783e-70          4
6     0.0019720649 12703.04   236.9434 1.963094e-52          6
~~~
{: .output}



~~~
write.csv (competition@results, file = "temp/competition_result.csv")
View(competition@results)
~~~
{: .language-r}



~~~
Error in check_for_XQuartz(): X11 library is missing: install XQuartz from xquartz.macosforge.org
~~~
{: .error}

Which settings gave delta.AICc < 2?

~~~
aicmods <- which(competition@results$delta.AICc < 10)
competition@results[aicmods,]
~~~
{: .language-r}



~~~
   settings features  rm train.AUC avg.test.AUC var.test.AUC avg.diff.AUC
11    H_1.5        H 1.5 0.7926666    0.7794132 1.056333e-04   0.01218845
12  LQH_1.5      LQH 1.5 0.7903235    0.7761602 4.479895e-05   0.01261797
   var.diff.AUC avg.test.orMTP var.test.orMTP avg.test.or10pct
11 1.457111e-04    0.001666667   1.111111e-05        0.1114680
12 7.913231e-05    0.001666667   1.111111e-05        0.1181015
   var.test.or10pct     AICc delta.AICc     w.AIC parameters
11     0.0003327799 12466.10  0.0000000 0.5553354         24
12     0.0003238597 12466.55  0.4458356 0.4443686         23
~~~
{: .output}

#### View model predictions (maps).  

~~~
plot(competition@predictions[[aicmods]])
~~~
{: .language-r}

<img src="../fig/rmd-enmeval5-1.png" title="plot of chunk enmeval5" alt="plot of chunk enmeval5" width="612" style="display: block; margin: auto;" />

#### Overview of model performances  
Plot delta.AICc for different settings that we selected in ENMeval   

~~~
par(mfrow=c(2,2))
eval.plot(competition@results,      'avg.test.AUC')
eval.plot(competition@results,      'avg.diff.AUC')
eval.plot(competition@results,   'avg.test.or10pct')
eval.plot(competition@results, 'avg.test.orMTP')
~~~
{: .language-r}

<img src="../fig/rmd-enmeval6-1.png" title="plot of chunk enmeval6" alt="plot of chunk enmeval6" width="432" style="display: block; margin: auto;" />

#### Model complexicility vs. model performances  
There are many fancy approaches to explore the original output of ENMeval(i.e. Myresults.csv), here deltAIC was plotted against meanAUC across diverse model setting, both these metrics can be used to measure model complexity, in this figure, the more down left of "point" position, the more less complex model setting represents.  

~~~
plot(competition@results$avg.test.AUC, 
     competition@results$delta.AICc, 
     bg=competition@results$features, pch=21, 
     cex= competition@results$rm/2)
legend("topright", legend=unique(competition@results$features), pt.bg=competition@results$features, pch=21)
mtext("Circle size proportional to regularization multiplier value")
~~~
{: .language-r}

<img src="../fig/rmd-enmeval7-1.png" title="plot of chunk enmeval7" alt="plot of chunk enmeval7" width="612" style="display: block; margin: auto;" />


#### Different ways of data seperation.  
~![]({{ page.root }}/fig/enmeval1.png)    

~~~
#T Viscualize a data parition with the Checkerboard1 method
check1 <- get.checkerboard1(occurrences.ok, environments, bg, aggregation.factor=5)

#T Checkboar parition with differnt aggregation value
check1.large <- get.checkerboard1(occurrences.ok, environments, bg, aggregation.factor=30)

#T Checkerboard2
check2 <- get.checkerboard2(occurrences.ok, environments, bg, aggregation.factor=c(5,5))

#T k-1 Jackknife
jack <- get.jackknife(occurrences.ok, bg)

#T Random k-fold
random <- get.randomkfold(occurrences.ok, bg, k=5)# example generating 5 bins randomply
~~~
{: .language-r}

We can directly use those methods in model competitation, using ` methods="block" `

~~~
competition <- ENMevaluate(occ = occ_coord,          # set the occurrence data for ENMeval
                           env = env,          # set the environmental data
                           bg.coords = bg_coord,     # set the background data
                           method = "block",
                           RMvalues=1,
                           fc = c("L", "LQ")
                           )

competition <- ENMevaluate(occ = occ_coord,          # set the occurrence data for ENMeval
                           env = env,          # set the environmental data
                           bg.coords = bg_coord,     # set the background data
                           method = "checkerboard1",
                           RMvalues=1,
                           fc = c("L", "LQ")
                           )
~~~
{: .language-r}


> ## Challenge: use "block" and "checkerboard1" methods to spatial parting occurrence records, manipulate the RMvalues () parameter, and compare the models  
> load occurrences & raster layers   
> build a `xxx meter` buffer around occurrences    
> `mask` raster by the buffer of occurrences   
> generate random samples from the masked raster using `sampleRandom()`  
> prepare the **coordinates** of occurrences and background points  
> revise the parameters of `ENMevaluate()`: **RMvalues**, **method**.
> look at **results** and **predictions**   
> > ## Solution
> > 
> > ~~~
> > library("raster")
> > library("dismo")
> > library("ENMeval")
> > 
> > # prepare spatial occ data
> > if(!file.exists("data/occ_raw.rdata")){
> >   occ_raw <- gbif(genus="Dasypus",species="novemcinctus",download=TRUE) 
> >   save(occ_raw,file = "data/occ_raw.rdata")
> > }else{
> >   load("data/occ_raw.rdata")
> > }
> > occ_clean <- subset(occ_raw,(!is.na(lat))&(!is.na(lon))) 
> > occ_unique <- occ_clean[!duplicated( occ_clean[c("lat","lon")]  ),]
> > occ_unique_specimen <- subset(occ_unique, basisOfRecord=="PRESERVED_SPECIMEN")
> > occ_final <- subset(occ_unique_specimen, year>=1950 & year <=2000)
> > coordinates(occ_final) <- ~ lon + lat
> > myCRS1 <- CRS("+init=epsg:4326") # WGS 84
> > crs(occ_final) <- myCRS1
> > 
> > # prepare raster data
> > if( !file.exists( paste0("data/bioclim/bio_10m_bil.zip")   )){
> >   utils::download.file(url="http://biogeo.ucdavis.edu/data/climate/worldclim/1_4/grid/cur/bio_10m_bil.zip",
> >                        destfile="data/bioclim/bio_10m_bil.zip"   ) 
> >   utils::unzip("data/bioclim/bio_10m_bil.zip",exdir="data/bioclim") 
> > }
> > 
> > # load rasters
> > clim_list <- list.files("data/bioclim/",pattern=".bil$",full.names = T)
> > clim <- raster::stack(clim_list) 
> > 
> > occ_buffer <- buffer(occ_final,width=4*10^5) #unit is meter
> > clim_mask <- mask(clim, occ_buffer)
> > 
> > set.seed(1) 
> > bg <- sampleRandom(x=clim_mask,
> >                    size=10000,
> >                    na.rm=T, #removes the 'Not Applicable' points  
> >                    sp=T) # return spatial points 
> > 
> > # select your input data (coordinates, raster)
> > env <- clim_mask[[c("bio1","bio5","bio6","bio12")]]
> > occ_coord <- occ_final@coords
> > bg_coord <- bg@coords
> > 
> > # run ENMeval using two method to spatial parting occurrence records#######
> > results_bl <- ENMevaluate(occ, env, bg, RMvalues=seq(0.5,4,0.5),method='block')
> > results_ch <- ENMevaluate(occ, env, bg, RMvalues=seq(0.5,4,0.5),method='checkerboard1')
> > 
> > # Selecting settings gave delta.AICc < 2 in block method####
> > aicmods1 <- which(res_bl@results$delta.AICc < 2)
> > res_bl@results[aicmods1,]
> > 
> > # Selecting settings gave delta.AICc < 2 in checkerboard####
> > aicmods2 <- which(res_ch@results$delta.AICc < 2)
> > res_ch@results[aicmods2,]
> > 
> > # View prediction of the best model in block and checkerboard methods#####
> > plot(stack( res_bl@predictions[[aicmods1]],
> >             res_ch@predictions[[aicmods2]]) )
> > ~~~
> > {: .language-r}
> {: .solution}
{: .challenge}
{% include links.md %}

